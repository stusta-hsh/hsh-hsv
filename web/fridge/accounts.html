<!DOCTYPE html>
<html>

<head>
	<title>Getränkeliste</title>
</head>

<script src="../lib/jquery-3.5.1.js"></script>

<body>
	<div id='header'>
		<a id='prev'>*</a>
		< <span id='curr'></span> >
		<a id='next'>*</a>
	</div>
	<table id="table">
		<thead>
			<tr id='headline'>
				<td/>
			</tr>
		</thead>
		<tbody>
		</tbody>
		<tfoot>
			<tr>
				<td>
					<input id='textAdd' onkeydown="textAdd_keydown(event)" oninput="textAdd_input(event)" autocomplete="off" style='width: 300px'/> <hr/>
					<select id='opts' size='3' style='width: 300px'/>
				</td>
			</tr>
		</tfoot>
	</table>
</body>

<script>

var categories;
var params = new URLSearchParams(window.location.search);
var ajaxParams = $.extend({}, {
	date: params.get('date') ?? undefined,
	floor: params.get('floor') ?? undefined
});

$.get("../api/fridge/accounts", ajaxParams)
	.done(function(data) {
		// Dates
		$('#prev').html(data.dates.prev ?? '*').attr('href', '?' + $.param($.extend({date: data.dates.prev}, { floor: ajaxParams.floor ?? undefined })));
		$('#next').html(data.dates.next ?? '*').attr('href', '?' + $.param($.extend({date: data.dates.next}, { floor: ajaxParams.floor ?? undefined })));

		// Categories
		data.categories.forEach(category => {
			$("#headline").append(`<th> ${category.name} (${category.value}€) </th>`);
		})
		categories = data.categories;

		// Accounts
		data.accounts.forEach(a => {
			var userLine = "<tr><td>" + userNameRoom(a.user.name, a.room.house, a.room.floor, a.room.room) + "</td>";
			for (i = 0; i < categories.length; i++) { 
				userLine += `<td><input class="accountInput" type="number" min="0" step="1" onchange="accountInput_change(event)"
					id="${a.user.id}-${i}" value="${a.account[i]}"></td>`;
			}
			userLine += `</td>`;
			$("#table").append(userLine);
		});
	})
	.fail(function(data) {
		alert(data.responseText);
	});

function textAdd_input(event) {
	if (textAdd.value == '') { return; }
	$.get("../api/user/suggest", { query: $("#textAdd").val(), date: ajaxParams.date })
		.done(function(data) {
			$("#opts").empty();
			for (i = 0; i < data.length; i++) {
				entry = $("#opts")
					.append($("<option />")
						.val(data[i].id)
						.text(userNameRoom(data[i].name, data[i].house, data[i].floor, data[i].room)));
			}
			$("#opts option:first").attr("selected", "selected");
		})
		.fail(function(data) {
			alert(data.responseText);
		});
}

function textAdd_keydown(event) {
	if (event.keyCode === 40) 		{ $("#opts").selectedIndex++; event.preventDefault(); }	// Pfeil nach unten -> nächstes Element in der Liste selektieren
	else if (event.keyCode === 38)	{ $("#opts").selectedIndex--; event.preventDefault(); }	// Pfeil nach oben -> vorheriges Element selektieren
	else if (event.keyCode === 13)	{														// Enter-Taste
		event.preventDefault();
		for (row of $(".account_row")) {
			if (row.getAttribute('value') === $("#opts").value) {							// wenn der User, der hinzugefügt werden soll, schon vorhanden ist
				row.children[1].firstElementChild.focus();									// den Fokus auf seine Zeile setzen
				$("#textAdd").value = ""; $("#opts").innerHTML = "";
				return;
			}
		}																					// Ansonsten: neue Zeile für User hinzufügen
		var newrow = document.getElementById("table").insertRow(++count_results);			// Neue Zeile erstellen und in Tabelle einfügen
		var c0 = newrow.insertCell(0); c0.innerHTML = $("#opts").selectedOptions[0].text;	// Erste Spalte: Name
		for (i = 0; i < count_categories; i++) {											// Restliche Spalten: Formularfelder
			var c = newrow.insertCell(i+1);
			c.innerHTML = "<input class=\'account_input\' type=\'number\' min=\'0\' step=\'1\' id=\'" + $("#opts").value + "-" + i + "\' value=\'0\' onchange=\'accountInput_change(event)\'/>";
			if (i == 0) { c.children[0].focus(); }											// Das erste Feld fokussieren
		}
		$("#textAdd").value = ""; $("#opts").innerHTML = "";								// Inputfeld leeren
	}
}

function userNameRoom(name, house, floor, room) {
	output = name;
	switch (house) {
		case null: output += " (extern)"; break;
		case '9': output += ` (${100*floor + 1*room})`; break;
		default: output += ` (${house}/${100*floor + 1*room})`; break;
	}
	return output;
}

</script>
</html>